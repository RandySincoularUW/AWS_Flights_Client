<!DOCTYPE html>
<!-- This version uses a different geolocation api -->
<!-- https://ip-api.com/docs/api:json -->
<!-- It does not require https/ssl to be configured-->

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=\, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
      integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
      integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
      crossorigin=""
    ></script>
    <style>
      #ourMap {
        height: 360px;
      }
    </style>

    <title>Where am I?</title>
  </head>
  <body>
    <h1>Where am I Located?</h1>

    <p>Click the button to get your coordinates and display them on a map.</p>

  <button color="Blue" onclick="getLocation()">Try It</button>

  <p id="demo">

  </p>


    <div id="main">
        <div id="location" class="sub">
            <h2>And you are in...</h2>
            <div class="address"></div>
        </div>
    </div>
    <div id="ourMap"></div>

<script>
// Get Location of User

console.log(" in script to get location ...")

var x = document.getElementById("demo");

async function getLocation() {

console.log(" in getLocation ...")

var endpoint = 'http://ip-api.com/json/?fields=status,message,lat,lon';

try {


      // Get geolocation
      console.log("fetching geolocation api ...")
      const response = await fetch(endpoint)

      const json = await response.json()

      if(json.status != 'success') {
          console.error("Geolocation failed ... " + json.message)
      }

      else {
        showPosition(json)
      }
      console.log("status: " + json.status)
      console.log(" lat: " + json.lat)
      console.log(" lon: " + json.lon)
}
catch (error) {
      console.error("Error getting geolocation. " + error.stack)
}

} // end getLocation
    

// This function gets called if you allow your location
function showPosition(position) {

    console.log("in showPosition() ...")

    // Display the latitude and longitude on the web page
    x.innerHTML="Latitude: " + position.lat + "<br>Longitude: " + position.lon;

    // Set the latitude and longitude variables with current location
    latitude = position.lat
    longitude = position.lon

      // ******   Leaflet Map  *******

      const mymap = L.map('ourMap').setView([0, 0], 8);
      const attribution =
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';

      const tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
      const tiles = L.tileLayer(tileUrl, { attribution });
      tiles.addTo(mymap);

      marker = L.marker([latitude, longitude]).addTo(mymap)
      circle = L.circle([latitude, longitude], {radius:1000}).addTo(mymap)

        // Always set the view to current lat lon and zoom!
        mymap.setView([latitude, longitude], mymap.getZoom());
        marker.setLatLng([latitude, longitude]);

      console.log("all done ...")

    }  // end showPosition()

    </script>
  </body>
</html>
